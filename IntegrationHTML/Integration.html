<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta name=""viewport" content="width=device-width, initial-scale=1.0" />
        <title>WA8 Control Panel</title>
        <style>
            body{font-family:Arial,Helvetica,sans-serif;color:#444;text-align:center;margin:0;padding:24px 12px;}
            h1, h2, h3 {margin-bottom:16px;}
            .controlPanel,.randomStates,.trafficLights,.stateMachine,.manualControls{margin:20px;max-width: 640px;}
            .controlRow,.sectionRow,.stateRow,.manualRow{display:flex;justify-content:center;gap:18px;flex-wrap:wrap;}
            .sectionRow{margin:6px auto;max-width:1280px;}
            .sectionColumn{flex:1 1 1;min-width:300px;}
            .controlBlock,.stateBlock,.manualBlock {display:flex;flex-direction:column;align-items:center;padding:12px;border-radius:12px;background-color:#f5f5f5;box-shadow:0 2px 6px rgba(0,0,0,0.1);min-width: 160px;}
            .controlLabel,.stateLabel{font-size:16px;margin:bottom 8px;}
            .btnToggle,.btnAction{font-size:16px;padding:10px 20px;border:none;border-radius:10px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.15);transition:transform .1s ease;}
            .btnToggle:active,.btnAction:active{transform:scale(0.97);}
            .btnToggle.on{background:#2e7d32;color:#fff;}
            .btnToggle.off{background:#c62828;color:#fff;}
            .btnAction{background:#1976d2;color:#fff;}
            .stateBox{height:16px;width:100%;border-radius:10px;background-color:#c62828;margin-bottom:6px;}
            .stateBox.on{background-color:#2e7d32;}
            .trafficStack{display:flex;flex-direction:column;align-items:center;gap:24px;padding:16px;background-color:#eee;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
            .trafficIndicator{width:48px;height:48px;border-radius:50%;background-color:#999;opacity:0.3;transition:opacity 0.3s ease;}
            .trafficIndicator.on{opacity:1;}
            #trafficRed.on{background-color:#c62828}
            #trafficYellow.on{background-color:#fbc02d;}
            #trafficGreen.on{background-color:#2e7d32;}
            .stateGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-top:16px;}
            /* .stateCell{font-size:14px;padding:16px;border-radius:8px;background-color:#ddd;font-weight:bold;color:#444;box-shadow:0 2px 4px rgba(0,0,0,0.1);transition:background-color 0.3s ease;} */
            .stateCell{display:flex;align-items:center;justify-content:center;min-height:12px;text-align:center;padding:16px 8px; border-radius:8px;background-color:#ddd;font-weight:bold;color:#444;box-shadow:0 2px 4px rgba(0,0,0,0.1);transition:background-color 0.3s ease;font-size:14px;}
            .stateCell.active{background-color:#2e7d32;color:#fff;}
            .statusFeedback{margin-top:24px;font-size:13px;color:#555;}
            .hint{font-size:11px;color:#777;margin-top:8px;}
            footer{margin-top:24px;background-color:#abbaba;color:#777;padding:18px;font-size:12px;}
        </style>
        <script>
            window.onload = function() {
                const state ={
                    switch1: 0,
                    switch2: 0,
                    state1: 0,
                    state2: 0,
                    photocell: 0,
                    ultrasonic: 0,
                    trafficLight: 0,
                    bridgeState: 1,
                    manualLabel: 'Manual',
                    nextState: 'Next State'
                };

                function on(v) {return v === 1 || v === "1" || v === true;}
                function setBtn(btn, onState) {
                    btn.classList.toggle('on', onState);
                    btn.classList.toggle('off', !onState);
                    btn.textContent = onState ? 'ON' : 'OFF';
                    btn.setAttribute('aria-pressed', onState ? 'true' : 'false');
                }
                function setStateBox(el, onState) {
                    el.classList.toggle('on', onState);
                    el.classList.toggle('off', !onState);
                }
                function setTrafficLight(val) {
                    ['trafficRed', 'trafficYellow', 'trafficGreen'].forEach(id => {document.getElementById(id).classList.remove('on');});
                    const activeId = ['trafficRed', 'trafficYellow', 'trafficGreen'][val];
                    if (activeId) document.getElementById(activeId).classList.add('on');
                }
                function setActiveState(stateNum){
                    for(let i=1;i<=8;i++){
                        const cell = document.getElementById('state-${i}');
                        cell.classList.toggle('active', i === stateNum);
                    }
                }
                function renderStatus() {
                    document.getElementById('status').textContent=`Status: { switch1: ${state.switch1}, switch2: ${state.switch2}, bridgeState: ${state.bridgeState} }`;
                }
                function applyState(s) {
                    setBtn(document.getElementById('switch1'), on(s.switch1));
                    setBtn(document.getElementById('switch2'), on(s.switch2));
                    setStateBox(document.getElementById('state1'), on(s.state1));
                    setStateBox(document.getElementById('state2'), on(s.state2));
                    setStateBox(document.getElementById('photocell'), on(s.photocell));
                    setStateBox(document.getElementById('ultrasonic'), on(s.ultrasonic));
                    setTrafficLight(parseInt(s.trafficLight));
                    setActiveState(parseInt(s.bridgeState));
                    document.getElementById('manualBtn').textContent = s.manualLabel || 'Manual';
                    document.getElementById('nextStateBtn').textContent = s.nextState || 'Next State';
                    renderStatus();
                }
                function poll() {fetch('/state').then(r=>r.json()).then(applyState).catch(()=>{});}

                document.getElementById('switch1').addEventListener('click', () => {
                    state.switch1 = state.switch1 ? 0 : 1;
                    state.state1 = state.switch1;
                    fetch(state.switch1 ? '/switch1on' : '/switch1off');
                    renderStatus();
                });

                document.getElementById('switch2').addEventListener('click', () => {
                    state.switch2 = state.switch2 ? 0 : 1;
                    state.state2 = state.switch2;
                    fetch(state.switch2 ? '/switch2on' : '/switch2off');
                    renderStatus();
                });

                document.getElementById('manualBtn').addEventListener('click', () => {
                    fetch('/manualOverride').catch(() => {});
                });

                document.getElementById('nextStateBtn').addEventListener('click', () => {
                    fetch('/nextState').catch(() => {});
                });

                poll();
                setInterval(poll, 1000);
            };
        </script>
    </head>
    <body>
        <header>
            <h1>WA8 Single Leaf Bridge</h1>
            <h2>Wireless Control Panel</h2>
        </header>
        <main>
            <div class="sectionRow">
                <section class="controlPanel sectionColumn">
                    <h3>Bridge Controls</h3>
                    <div class="controlRow">
                        <article class="controlBlock">
                            <label for="switch1" class="controlLabel">Emergency Stop</label>
                            <button id="switch1" class="btnToggle off" aria-pressed="false">OFF</button>
                            <div class="hint">Click to toggle</div>
                        </article>
                        <article class="controlBlock">
                            <label for="switch2" class="controlLabel">Activate Bridge</label>
                            <button id="switch2" class="btnToggle off" aria-pressed="false">OFF</button>
                            <div class="hint">Click to toggle</div>
                        </article>
                    </div>
                </section>
                <!-- Manual Controls -->
                <section class="manualControls">
                    <h3>Manual Controls</h3>
                    <div class="manualRow">
                        <article class="manualBlock">
                            <button id="manualBtn" class="btnAction">Manual</button>
                            <div class="hint">Shows current override action</div>
                        </article>
                        <article class="manualBlock">
                            <button id="nextStateBtn" class="btnAction">Next State</button>
                            <div class="hint">Displays upcoming state</div>
                        </article>
                    </div>
                </section>
            </div>
            <!-- Traffic Lights -->
            <div class="sectionRow">
                <section class="trafficLights">
                    <h3>Traffic Lights</h3>
                    <div class="trafficStack">
                        <div id="trafficRed" class="trafficIndicator off"></div>
                        <div id="trafficYellow" class="trafficIndicator off"></div>
                        <div id="trafficGreen" class="trafficIndicator off"></div>
                    </div>
                    <div class="hint">Only one light is active at a time</div>
                </section>                
                <div>
                    <!-- State Machine -->
                    <section class="stateMachine">
                        <h3>Bridge State Machine</h3>
                            <div class="stateGrid">
                                <div id="state-1" class="stateCell">Lowered</div>
                                <div id="state-2" class="stateCell">Prepare Raise</div>
                                <div id="state-3" class="stateCell">Raising</div>
                                <div id="state-4" class="stateCell">Raised</div>
                                <div id="state-5" class="stateCell">Prepare Lower</div>
                                <div id="state-6" class="stateCell">Lowering</div>
                                <div id="state-7" class="stateCell">Emergency Lower</div>
                                <div id="state-8" class="stateCell">Emergency Raise</div>
                            </div>
                        <div class="hint">Current state is highlighted</div>
                    </section>
                    <!-- Random States -->
                    <section class="randomStates sectionColumn">
                        <h3>Random States</h3>
                        <div class="stateRow">
                            <article class="stateBlock">
                                <label class="stateLabel">Street Lights</label>
                                <div id="photocell" class="stateBox off"></div>
                                <div class="hint">Reflects ambient light sensor</div>
                            </article>
                            <article class="stateBlock">
                                <label class="stateLabel">Boat Sensor</label>
                                <div id="ultrasonic" class="stateBox off"></div>
                                <div class="hint">Detects boat proximity</div>
                            </article>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Status Feedback -->
            <section class="statusFeedback">
                <div id="status">Status: { switch1: 0, switch2: 0, bridgeState: 1 }</div>
            </section>
        </main>
        <footer>
            Team WA8 Wifi Control Webpage for AP Access to ESP32 Dev Board in ENGG2000/3000 Scale Model Bridge Construction Project
        </footer>
    </body>
</html>
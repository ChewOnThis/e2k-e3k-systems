<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title> MidSem WA8 Control Panel </title>
    <style>
        :root{
            --borderwidth: 0px;
            --buttonRegOn: green;
            --buttonRegOff: red;
            --trafficRedOn:#ff2b2b;
            --trafficRedOff: #3a0d0d;
            --trafficRedGlow: rgba(255, 40, 40, 0.65);
            --trafficYellowOn: #ffd400;
            --trafficYellowOff: #3a3200;
            --trafficYellowGlow: rgba(255, 212, 0, 0.55);
            --trafficGreenOn: #1eea5a;
            --trafficGreenOff: #0e2a1a;
            --trafficGreenGlow: rgba(30, 234, 90, 0.55);
            --trafficHousing: #111;
            --trafficBezel: #000;
            --estopOn:red;
            --estopOff:darkRed;
            --headFoot: calc(100% - (var(--borderwidth)*2));
            --showTag: true;
            --backLight:#282f3e;
            --backMid :#1e232f;
            --backDarkMid :#14171f;
            --backDark:#0f1115;
            --stateDefault: #2e384d;
            --textColourDefault: #999;
            --titleColour: #dfdede;
        }
        a {
            color:red;
        }
        * {
            margin: 5px;
        }
        body {
            border: var(--borderwidth) solid black;
            display:flex; 
            font-family: Arial, Helvetica, sans-serif;
            color:#ebebeb;
            text-align: center;
            flex-direction: column;
            min-width: min-content;
            width:100%;
            align-items:center;
            background:linear-gradient(var(--backMid), var(--backLight),var(--backMid), var(--backDark));
        }
        header{
            border: var(--borderwidth) solid red;
            width: var(--headFoot);
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-evenly;
        }
        h1, h2{
            color: var(--titleColour);
        }
        h3, h4, h5, label{
            color:var(--textColourDefault);
        }
        .debug{
            border: var(--borderwidth) solid blue;
            justify-self: flex-end;
        }
        .title{
            border: var(--borderwidth) solid black;
            display: flex;
            justify-self: center;
            flex-direction: column;
        }
        main{
            border: var(--borderwidth) solid green;
            display:flex;
            flex-direction: row;
            justify-content: space-evenly;
            align-items: stretch;
            align-content: center;
            height:100%;
        }
        .sideBar{
            background-color: var(--backDark);
            background-color: green;
            border: var(--borderwidth) solid blue;
            border-radius: 16px;
            display:flex;
            flex-direction: column;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            align-content: center;
            justify-self: flex-start;
        }
        .mainBlock{
            border: var(--borderwidth) solid yellow;
            background-color: var(--backDarkMid);
            background-color:red;
            border-radius: 16px;
            display:flex;
            flex-direction: column;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            align-content: center;
            max-width:785px;
        }
        section {
            border: var(--borderwidth) solid;
            display:flex;
            flex-wrap: wrap;
            gap:10px;
            justify-content: center;
            align-items: center;
            align-content: center;
        }
        #buttons{
            border-color: red;
        }
        #states{
            border-color: goldenrod;
        } 
        footer {
            border: var(--borderwidth) solid blue;
            color: #777; 
            font-size:12px; 
            text-align: center;
            width:var(--headFoot);
            padding-top:40px;
        }
        .box{
            border: var(--borderwidth) solid;
            display:flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .controlPanel {
            border: var(--borderwidth) solid blue;
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        .controlBlock{
            border:var(--borderwidth) solid black;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: space-evenly;
            align-items: center;
        }
        .statePanel{
            border: var(--borderwidth) solid red;
            display:flex;
            flex-direction: column;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        .panel{
            border: var(--borderwidth) solid orange;
            display: flex;
            flex-direction: row;
            flex-wrap:wrap;
            justify-content: center;
            align-items: center;
        }

        .stateBlock{
            border: var(--borderwidth) solid green;
            display:flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #buttonBox {
            border: var(--borderwidth) solid yellow;
        }
        #stateBox {
            border: var(--borderwidth) solid pink;
            flex-direction: row;
        }
        .stateToggle{
            padding: 10px 20px;
            border-radius: 10px;
            background-color: --;

        }
        button{
            border:none;
            cursor:pointer;
        }
        .buttonToggle{
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 5px 0px darkgoldenrod, 0px 0px 0px 5px black;
            transition:transform .1s ease;
        }
        .buttonToggle:active{
            transform:scale(0.8);
        }
        .buttonToggle.eStop{
            padding: 0;
            width: 80px;
            height: 80px;
            border-radius: 50%;
        }
        .buttonToggle.on{
            background:var(--buttonRegOn);
        }
        .buttonToggle.off{
            background:var(--buttonRegOff);
        }
        .buttonToggle.eStop.on{
            background:var(--estopOn);
        }
        .buttonToggle.eStop.off{
            background:var(--estopOff);
        }
        .buttonToggle.debugButton.off{
            background: var(--buttonRegOff);
        }
        .buttonToggle.debugButton.on{
            background: var(--buttonRegOn);
        }
        .idContainer{
            border: var(--borderwidth) solid yellow;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .idBox{
            border: var(--borderwidth) solid orange;
            display:flex;
            flex-direction: column;
            align-items: flex-start;
            gap:5px;
        }
        h5{
            white-space:nowrap;
            font-size:clamp(0.67em, 0.83em, 1em);
        }
        .trafficLight{
            --S: clamp(0.5em, 4em, 5em);
            width: var(--S);
            padding: calc(var(--S) *0.12);
            background:linear-gradient(#1a1a1a, #0e0e0e);
            border: calc(var(--S) *0.014) solid #000;
            border-radius: calc(var(--S)*0.12);
            display:grid;
            gap:calc(var(--S) * 0.11);
            box-shadow: inset 0 calc(var(--S)*0.05) calc(var(--S)*0.09) rgba(255,255, 255, 0.05), inset 0 calc(var(--S)* -0.035) calc(var(--S)*0.10) rgba(0,0,0,0.60), 0 calc(var(--S)*0.07) calc(var(--S)*0.14) rgba(0,0,0,0.60);
        }
        .well {
            background: linear-gradient(180deg, #0d0d0d 0%, #070707 100%);
            padding:calc(var(--S) * 0.06);
            border-radius:calc(var(--S)*0.10);
            border:calc(var(--S)*0.08) solid #000;
            box-shadow: inset 0 calc(var(--S)*0.06) calc(var(--S)*0.10) rgba(255, 255, 255, 0.06), inset 0 -calc(var(--S)* -0.08) calc(var(--S)*0.12) rgba(0,0,0,0.7);
        }
        .lamp {
            width:inherit;
            aspect-ratio: 1/1;
            border-radius: 50%;
            border: calc(var(--S) * 0.03) solid #000;
            position: relative;
            background: radial-gradient(160% 120% at 30% 30%, rgba(255, 255, 255, 0.18) 0%, transparent 35%), var(--baseColor, #222);
            box-shadow: inset 0 calc(var(--S) *0.07) calc(var(--S)*0.12) rgba(255, 255, 255, 0.06), inset 0 calc(var(--S)*0.10) calc(var(--S)*0.14) rgba(0,0,0,0.45);
            transition: box-shadow 140ms ease, background-color 140ms ease, filter 140ms ease;
        }
        .lamp.off {
            filter: saturate(0.85) brightness(0.75);
            box-shadow: inset 0 0 8px rgba(0,0,0,0.8);
        }
        .lamp.on.red {
            --baseColor: var(--trafficRedOn);
            background-color: var(--baseColor);
            box-shadow: 0 0 calc(var(--S) * 0.14) calc(var(--S) * 0.03) var(--baseColor), 
                        0 0 calc(var(--S) * 0.30) calc(var(--S) * 0.06) var(--baseColor),
                        inset 0 calc(var(--S) * 0.07) calc(var(--S) * 0.12) rgba(255, 255, 255, 0.06), 
                        inset 0 calc(var(--S) * 0.10) calc(var(--S) * 0.14) rgba(0, 0, 0, 0.45);
        }
        .lamp.off.red {
            --baseColor: var(--trafficRedOff);
        }
        .lamp.on.yellow {
            --baseColor: var(--trafficYellowOn);
            background-color: var(--baseColor);
            box-shadow: 0 0 calc(var(--S) * 0.14) calc(var(--S) * 0.03) var(--baseColor), 
                        0 0 calc(var(--S) * 0.30) calc(var(--S) * 0.06) var(--baseColor),
                        inset 0 calc(var(--S) * 0.07) calc(var(--S) * 0.12) rgba(255, 255, 255, 0.06), 
                        inset 0 calc(var(--S) * 0.10) calc(var(--S) * 0.14) rgba(0, 0, 0, 0.45);
        }
        .lamp.off.yellow {
            --baseColor: var(--trafficYellowOff);
        }
        .lamp.on.green {
            --baseColor: var(--trafficGreenOn);
            background-color: var(--baseColor);
            box-shadow: 0 0 calc(var(--S) * 0.14) calc(var(--S) * 0.03) var(--baseColor), 
                        0 0 calc(var(--S) * 0.30) calc(var(--S) * 0.06) var(--baseColor),
                        inset 0 calc(var(--S) * 0.07) calc(var(--S) * 0.12) rgba(255, 255, 255, 0.06), 
                        inset 0 calc(var(--S) * 0.10) calc(var(--S) * 0.14) rgba(0, 0, 0, 0.45);
        }
        .lamp.off.green {
            --baseColor: var(--trafficGreenOff);
        }
        .stateGrid{
            border:var(--borderwidth) solid yellow;
            gap:10px;
            display:grid;
            grid-template-columns: repeat(4, 1fr);
        }
        .stateCell{
            text-align: center;
            padding:16px 8px;
            border-radius: 8px;
            background-color: var(--stateDefault);
            font-weight: bold;
            color: var(--textColourDefault);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition:background-color 0.3s ease;
            font-size: 14px;
            place-content: center;
        }
    </style>
    <script>
        window.onload = function() {
            const state = {
                eStopBtn:           0,
                debugBtn:           0,
                stateSwitchBtn:     0,
                activateBridgeBtn:  0,
                photoCellState:     0,
                sonicState:         0,
                trafficLightState:  0,
                bridgeState:        1,
                nextState:          'Next State',
            }

            const traffic = {
                red: document.getElementById('redTraffic'),
                yellow: document.getElementById('yellowTraffic'),
                green: document.getElementById('greenTraffic'),
            }


            function on(v) {return v === 1 || v === "1" || v === true;}
            function setBtn(btn, onState, changeText) {
                btn.classList.toggle('on', onState);
                btn.classList.toggle('off', !onState);
                btn.textContent = changeText ? onState?'Active':'InActive':btn.textContent;
                btn.setAttribute('aria-pressed', onState ? 'true' : 'false');
            }
            function setBtnDisable(btn, onState, changeText) {
                btn.classList.toggle('on', onState);
                btn.classList.toggle('off', !onState);
                btn.textContent = changeText ? onState?'Active':'InActive':btn.textContent;
                btn.setAttribute('aria-pressed', onState ? 'true' : 'false');
                if (btn.getAttribute('aria-pressed')===false) btn.disabled = true;
            }
            function setStateBox(el, onState) {
                el.classList.toggle('on', onState);
                el.classList.toggle('off', !onState);
            }
            function setTrafficLight(state) {
                allOff();
                switch(state) {
                    case 0: setOn(red);
                    case 1: setOn(yellow);
                    case 2: setOn(green);
                }
            }
            function allOff() {
                traffic.forEach(el => {
                    el.classList.remove('on');
                    el.classList.setAttribute('aria-label', 
                        el.classList.contains('red)') ? 'Red light off' 
                            : el.classList.contains('yellow') ? 'Yellow light off' : 'Green light off'
                    );
                });
            }
            function setOn(el) {
                el.classList.remove('off');
                el.classList.add('on');
                const c = el.classList.contains('red)') ? 'Red light off' : 
                            el.classList.contains('yellow') ? 'Yellow light off' : 'Green light off';
                el.classList.setAttribute('aria-label', `${c} light on`);
            }

            function setActiveState(stateNum) {
                for (let i = 1; i<=8;i++) {
                    const cell = document.getElementById(`state-${i}`);
                    cell.classList.toggle('active', i === stateNum);
                }
            }
//TODO add statuses
            function renderStatus() {
                document.getElementById('status').textContent = 'Status: { }'
            }

            function poll() {
                fetch('/state')
                .then(r=>r.json())
                .then(applyState)
                .catch(()=>{});
            }

            function applyState(s) {
                setBtnDisable(document.getElementById('eStopBtn'), on(s.eStopBtn));
                setBtn(document.getElementById('debugBtn'), on(s.debugBtn));
                setBtn(document.getElementById('stateSwitchBtn'), state(s.stateSwitchBtn));
                setBtn(document.getElementById('activateBridgeBtn'), on(s.activateBridgeBtn));
                setStateBox(document.getElementById('photoCellState'), on(s.photoCellState));
                setStateBox(document.getElementById('sonicState'), on(sonicState));
                setTrafficLight(parseInt(s.trafficLightState));
                setActiveState(parseInt(s.bridgeState));
                document.getElementById('stateSwitchBtn').textContent = s.nextState || 'Next State';
                renderStatus;
            }

            document.getElementById('eStopBtn').addEventListener('click', () => {
                state.eStopBtn = state.eStopBtn ? 0 : 1;
                fetch(state.eStopBtn ? '/eStop/on' : '/eStop/off');
                renderStatus();
            });

            document.getElementById('debugBtn').addEventListener('click', () => {
                state.debugBtn = state.debugBtn ? 0 : 1;
                fetch(state.debugBtn ? '/debug/on' : '/debug/off');
                renderStatus();
            });

            document.getElementById('stateSwitchBtn').addEventListener('click', () => {
                state.stateSwitchBtn = state.stateSwitchBtn === 8 ? 1:state.stateSwitchBtn+1;
                fetch('/switchState');
                renderStatus();
            });

            document.getElementById('activateBridgeBtn').addEventListener('click', () => {
                state.activateBridgeBtn = state.activateBridgeBtn ? 0 : 1;
                fetch(state.activateBridgeBtn ? '/activateBridge/raise' : '/activateBridge/lower');
                renderStatus();
            });

            // poll();
            // setInterval(poll, 1000);
        }

    </script>
</head>
<body>
    <header>
        <div class="title">
            <h1> Team WA8 Single Leaf Bridge </h1>
            <h2> Wireless Control Panel </h2>
        </div>
    </header>
    <main> 
        <div class="sideBar" style="align-self:flex-start">
            <div class="controlBlock">
                <div class="box" id="buttonBox"> 
                    <label for="eStopBtn" class="controlLabel"> Emergency Stop </label>
                    <button id="eStopBtn" class="buttonToggle eStop on" aria-pressed="false" > OFF </button>
                </div>
            </div>
            <div class="controlBlock">
                <div class="box" id="buttonBox"> 
                    <label for="debugBtn" class="controlLabel"> Debug Mode </label>
                    <button id="debugBtn" class="buttonToggle debug on" aria-pressed="false" > OFF </button>
                </div>
            </div>
            <div class="idContainer">
                <div class="idContainer">
                    <h4>Systems: Group 88</h4>
                    <div class="idBox">
                        <h5>48253383 : Isabelle Farolan</h5>
                        <h5>48346992 : Brie McWhirter</h5>
                        <h5>47881453 : Nicholas Greenhouse</h5>
                        <h5>48074101 : Rikita Shil</h5>
                        <h5>47727330 : Christopher Stokan</h5>
                        <h5>47713623 : Aidan Williams</h5>
                        <h5>48275778 : Caleb Chew</h5>
                    </div>
                </div>
                <div class="idContainer">
                    <h4>Structures: Group 73</h4>
                    <div class="idBox">
                        <h5>47286091 : Adam Malvern</h5>
                        <h5>46375929 : Harry Vale</h5>
                        <h5>48347582 : Mohammad Haider</h5>
                        <h5>47408456 : Bailey Kee</h5>
                        <h5>47666412 : Adam Ruiz Diaz</h5>
                        <h5>46387897 : Michael Ferlauto</h5>
                        <h5>48096695 : Hasanuzzaman Shoeb</h5>
                    </div>
                </div>
            </div>
        </div>
        <div class="mainBlock">
            <section id="buttons">
                <div class="panel">
                    <div class="controlPanel">
                        <h3>Manual Controls</h3>
                        <div class="controlBlock">
                            <div class="box" id="buttonBox"> 
                                <label for="stateSwitchBtn" class="controlLabel"> Next State </label>
                                <button id="stateSwitchBtn" class="buttonToggle off" aria-pressed="false" > State </button>
                            </div>
                            <div class="box" id="buttonBox"> 
                                <label for="activateBridgeBtn" class="controlLabel"> Activate Bridge </label>
                                <button id="activateBridgeBtn" class="buttonToggle off" aria-pressed="false" > Still </button>
                            </div>
                        </div>
                    </div>
                    <div class="statePanel">
                        <h3>Sensor States</h3>
                        <div class="box" id="stateBox">
                            <div>
                                <label> Photocell Sensor </label>
                                <div id="photoCellState" class="stateCell">Not Detected</div>
                            </div>
                            <div>
                                <label> UltraSonic Sensor </label>
                                <div id="sonicState" class="stateCell">Not Detected</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="statePanel traffic">
                    <h3>Traffic System Panel</h3>
                    <div class="stateBlock">
                        <div class="trafficLight">
                            <div class="well">
                                <div id="redTraffic" class="lamp on red" role="img" aria-label="Red light on"></div>
                            </div>
                            <div class="well">
                                <div id="yellowTraffic" class="lamp off yellow" role="img" aria-label="Yellow light on"></div>
                            </div>
                            <div class="well">
                                <div id="greenTraffic" class="lamp off green" role="img" aria-label="Green light on"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="states">
                <div class="statePanel">
                    <h3>Bridge State Panel</h3>
                    <div class="stateGrid">
                        <div id="state-1" class="stateCell"><h4>Lowered</h4></div>
                        <div id="state-2" class="stateCell"><h4>Prepare Raise</h4></div>
                        <div id="state-3" class="stateCell"><h4>Raising</h4></div>
                        <div id="state-4" class="stateCell"><h4>Raised</h4></div>
                        <div id="state-5" class="stateCell"><h4>Prepare Lower</h4></div>
                        <div id="state-6" class="stateCell"><h4>Lowering</h4></div>
                        <div id="state-7" class="stateCell"><h4>Emergency Lower</h4></div>
                        <div id="state-8" class="stateCell"><h4>Emergency Raise</h4></div>

                    </div>
                </div>
            </section>
        </div>        
    </main>
    <footer>
        <p>Team WA8 Wifi Control Web-Based GUI for AP Access to the ESP32 Microcontroller for Controller over subsystems of the ENGG2000/3000 Scale Model Bridge Design/Contruction Project</p>
        <a href="https://github.com/ChewOnThis/e2k-e3k-systems" target="_blank">GitHub Repository</a>
    </footer>
</body>
</html>